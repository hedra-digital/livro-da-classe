

<% if can_execute?  %>
  <%= link_to t(:pdf, :scope => :book_nav), '#', :id =>'generate-pdf', :class =>'btn btn-default bc-blue tc-white' %>
<% end %>

<% if can_execute? %>
  <%= link_to t(:ebook, :scope => :book_nav), '#', :id =>'generate-ebook', :class =>'btn btn-default bc-blue tc-white' %>
<% end %>




<script type="text/javascript">
  var bookurl = '<%= book_generate_pdf_path(@book.uuid) %>';
  var ebookurl = '<%= book_generate_ebook_path(@book.uuid) %>';
  var ask_for_download_pdf_url = '<%= book_ask_for_download_pdf_path(@book.uuid) %>';

  function getByType(type){
    if (type == "pdf"){
      return {
        url : bookurl,
        title: "<%= t(:pdf_progress_title) %>",
        download: "<%= t(:pdf_generation_download) %>",
        error: "<%= t(:pdf_generation_error) %>"
      };
    } else if (type == "ebook"){
      return {
        url : ebookurl,
        title: "<%= t(:ebook_progress_title) %>",
        download: "<%= t(:ebook_generation_download) %>",
        error: "<%= t(:ebook_generation_error) %>"
      };
    } else {
      return {
        url : ebookurl + "?kindle=true",
        title: "<%= t(:kindle_progress_title) %>",
        download: "<%= t(:kindle_generation_download) %>",
        error: "<%= t(:kindle_generation_error) %>"
      };
    }
  }

  function generate(type){
    var o = getByType(type);
    $.ajax({
      url: o.url,
      dataType: 'json',
      beforeSend: function () {
        $(".progress-modal").fancybox({
          helpers : {
              overlay : {
                  locked : true,
                  closeClick : false
              },
              title: {
                type: 'inside',
                position: 'bottom'
              }
          },
          title: o.title,
          autoSize: true,
          minHeight: 10,
          closeBtn: true,
          autoCenter: true
        }).trigger('click')
      },
      context: document.body
    }).done(function(response) {
      if (response.result == "success") {
        parent.jQuery.fancybox.close();
        window.location = response.path;
      } else {
        var link = $(document.createElement('a')).attr('href',response.path).text('<%= t(:click_here) %>');
        $('img.progress-modal').hide();
        $('div.fancybox-title').text(o.download).append(link);
        $('div.fancybox-title').html();
      }
    }).fail(function(response) {
      alert(o.error);
    });
  }

  $("#generate-pdf").on("click", function (){
    generate("pdf");
  });

  $("#generate-ebook").on("click", function (){
    generate("ebook");
  });

  $("#generate-kindle").on("click", function (){
    generate("kindle");
  });
</script>
